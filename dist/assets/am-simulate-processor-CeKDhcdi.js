(function(){"use strict";const b={carrier:{freqRatio:.5,modulationIndex:1},lpf:{cutoff:4e3,q:.707,stages:16},detector:{attackTime:.5,releaseTime:4},compressor:{threshold:.01,ratio:30,releaseTime:.5,makeupGain:100},diode:{drop:.55,vt:.16,gain:.03,blend:.1},noise:{enabled:!0,level:.02}};function d(u){return JSON.parse(JSON.stringify(u))}class S{x1=0;x2=0;y1=0;y2=0;a0=0;a1=0;a2=0;b1=0;b2=0;updateCoefficients(t,s,i){const e=2*Math.PI*s/t,o=Math.sin(e),a=Math.cos(e),n=o/(2*i),h=(1-a)/2,c=1-a,f=(1-a)/2,r=1+n,p=-2*a,l=1-n;this.a0=h/r,this.a1=c/r,this.a2=f/r,this.b1=p/r,this.b2=l/r}process(t){const s=this.a0*t+this.a1*this.x1+this.a2*this.x2-this.b1*this.y1-this.b2*this.y2;return this.x2=this.x1,this.x1=t,this.y2=this.y1,this.y1=s,s}}class C{config;sampleRate;phase=0;phaseStep=0;envelope=0;attackCoeff=0;releaseCoeff=0;compEnvelope=0;compReleaseCoeff=0;lpfStages=[];noiseEnabled=!1;noiseLevel=0;noiseState=1;constructor(t,s){this.sampleRate=t,this.config=d(s),this.recomputeFromConfig()}updateConfig(t){this.config=d(t),this.recomputeFromConfig()}recomputeFromConfig(){const t=Math.max(1e-6,this.config.carrier.freqRatio),s=this.sampleRate*t;this.phaseStep=2*Math.PI*s/this.sampleRate;const i=1/s;this.attackCoeff=Math.exp(-1/(this.sampleRate*(i*this.config.detector.attackTime))),this.releaseCoeff=Math.exp(-1/(this.sampleRate*(i*this.config.detector.releaseTime))),this.compReleaseCoeff=Math.exp(-1/(this.sampleRate*this.config.compressor.releaseTime));const e=Math.max(1,Math.round(this.config.lpf.stages));this.lpfStages.length!==e&&(this.lpfStages=Array.from({length:e},()=>new S)),this.lpfStages.forEach(o=>{o.updateCoefficients(this.sampleRate,this.config.lpf.cutoff,this.config.lpf.q)}),this.noiseEnabled=this.config.noise.enabled,this.noiseLevel=this.config.noise.level}processSample(t){const s=this.modulate(t),i=this.noiseEnabled?s+this.whiteNoise():s,e=this.applyDiodeRectifier(i);this.updateEnvelope(e);const o=(this.envelope-1)/this.config.carrier.modulationIndex,a=this.applyCompressor(o),n=this.lpfStages.reduce((h,c)=>c.process(h),a);return{output:Math.max(-1,Math.min(1,n)),modulated:i}}whiteNoise(){let t=this.noiseState;return t^=t<<13,t^=t>>>17,t^=t<<5,this.noiseState=t,((t>>>0)/4294967295*2-1)*this.noiseLevel}modulate(t){const s=Math.cos(this.phase),i=(1+this.config.carrier.modulationIndex*t)*s;return this.phase+=this.phaseStep,this.phase>=2*Math.PI&&(this.phase-=2*Math.PI),i}applyDiodeRectifier(t){const{drop:s,vt:i,gain:e,blend:o}=this.config.diode,a=Math.max(0,t),n=t-s;let h=0;return n>0&&(h=Math.expm1(n/i)*e),a*(1-o)+h*o}updateEnvelope(t){t>this.envelope?this.envelope=this.attackCoeff*this.envelope+(1-this.attackCoeff)*t:this.envelope=this.releaseCoeff*this.envelope+(1-this.releaseCoeff)*t}applyCompressor(t){const s=Math.abs(t),{threshold:i,ratio:e,makeupGain:o}=this.config.compressor;s>this.compEnvelope?this.compEnvelope=s:this.compEnvelope=this.compReleaseCoeff*this.compEnvelope+(1-this.compReleaseCoeff)*s;let a=1;if(this.compEnvelope>i){const h=20*Math.log10(this.compEnvelope/i)/e;a=i*Math.pow(10,h/20)/this.compEnvelope}return t*a*o}}class M extends AudioWorkletProcessor{channels=[];config=d(b);fft=null;fftSize=2048;modulatedBuffer=new Float32Array(2048);bufferIndex=0;spectrumEnabled=!1;frameCounter=0;spectrumUpdateInterval=4;constructor(){super(),this.port.onmessage=t=>{t.data.type==="startSpectrum"?(this.fftSize=t.data.fftSize||2048,this.fft=new v(this.fftSize),this.modulatedBuffer=new Float32Array(this.fftSize),this.bufferIndex=0,this.spectrumEnabled=!0):t.data.type==="stopSpectrum"?(this.spectrumEnabled=!1,this.fft=null):t.data.type==="updateConfig"&&t.data.config&&this.applyConfig(t.data.config)}}applyConfig(t){this.config=d(t),this.channels.forEach(s=>s.updateConfig(this.config))}sendSpectrum(){if(!this.fft||!this.spectrumEnabled)return;const t=new Float32Array(this.fftSize),s=new Float32Array(this.fftSize);for(let e=0;e<this.fftSize;e++){const o=.5*(1-Math.cos(2*Math.PI*e/(this.fftSize-1)));t[e]=this.modulatedBuffer[e]*o,s[e]=0}this.fft.forward(t,s);const i=this.fft.getMagnitudes(t,s);this.port.postMessage({type:"spectrum",data:i})}process(t,s,i){const e=t[0],o=s[0];if(!e||!o||e.length===0)return!0;this.channels.length!==e.length&&(this.channels=e.map(()=>new C(sampleRate,this.config)));for(let a=0;a<e.length;a++){const n=e[a],h=o[a],c=this.channels[a];if(!(!n||!h||!c))for(let f=0;f<n.length;f++){const r=c.processSample(n[f]);h[f]=r.output,a===0&&this.spectrumEnabled&&(this.modulatedBuffer[this.bufferIndex]=r.modulated,this.bufferIndex=(this.bufferIndex+1)%this.fftSize)}}return this.spectrumEnabled&&(this.frameCounter++,this.frameCounter>=this.spectrumUpdateInterval&&(this.frameCounter=0,this.sendSpectrum())),!0}}class v{size;cosTable;sinTable;reverseTable;constructor(t){this.size=t,this.cosTable=new Float32Array(t/2),this.sinTable=new Float32Array(t/2),this.reverseTable=new Uint32Array(t);for(let e=0;e<t/2;e++)this.cosTable[e]=Math.cos(2*Math.PI*e/t),this.sinTable[e]=Math.sin(2*Math.PI*e/t);let s=1,i=t>>1;for(;s<t;){for(let e=0;e<s;e++)this.reverseTable[e+s]=this.reverseTable[e]+i;s<<=1,i>>=1}}forward(t,s){const i=this.size;for(let e=0;e<i;e++){const o=this.reverseTable[e];if(o>e){let a=t[e];t[e]=t[o],t[o]=a,a=s[e],s[e]=s[o],s[o]=a}}for(let e=2;e<=i;e*=2){const o=e/2,a=i/e;for(let n=0;n<i;n+=e)for(let h=0;h<o;h++){const c=h*a,f=this.cosTable[c],r=this.sinTable[c],p=n+h,l=n+h+o,m=f*t[l]+r*s[l],g=f*s[l]-r*t[l];t[l]=t[p]-m,s[l]=s[p]-g,t[p]+=m,s[p]+=g}}}getMagnitudes(t,s){const i=new Float32Array(this.size/2);for(let e=0;e<this.size/2;e++)i[e]=Math.sqrt(t[e]*t[e]+s[e]*s[e])/this.size;return i}}registerProcessor("am-simulate-processor",M)})();
